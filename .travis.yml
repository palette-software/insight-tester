language: go

go:
    - 1.6

env:
    matrix:
        - GIMME_OS=darwin GIMME_ARCH=386 GIMME_TYPE=binary
        - GIMME_OS=darwin GIMME_ARCH=amd64 GIMME_TYPE=binary
        - GIMME_OS=linux GIMME_ARCH=386 GIMME_TYPE=binary
        - GIMME_OS=linux GIMME_ARCH=amd64 GIMME_TYPE=binary
        - GIMME_OS=windows GIMME_ARCH=386 GIMME_TYPE=binary
        - GIMME_OS=windows GIMME_ARCH=amd64 GIMME_TYPE=binary
        # - TMP_GIMME_OS=darwin TMP_GIMME_ARCH=386 TMP_GIMME_TYPE=binary
        # - TMP_GIMME_OS=darwin TMP_GIMME_ARCH=amd64 TMP_GIMME_TYPE=binary
        # - TMP_GIMME_OS=linux TMP_GIMME_ARCH=386 TMP_GIMME_TYPE=binary
        # - TMP_GIMME_OS=linux TMP_GIMME_ARCH=amd64 TMP_GIMME_TYPE=binary
        # - TMP_GIMME_OS=windows TMP_GIMME_ARCH=386 TMP_GIMME_TYPE=binary
        # - TMP_GIMME_OS=windows TMP_GIMME_ARCH=amd64 TMP_GIMME_TYPE=binary
    global:
        - secure: "FqOqp2bWrcQ2vTVqHAj5RhvMra7sxWU4TEoTq2CWz0s20+vL/B36fOPL69kIZ9sHfcxlW76HH2hdhsHokC82rnXOLfsM6m00A8nYqhOQleuS1lGTwMqXhC019+sX7RiuX4OghvZ4Jh3QMJ3nZLBJGy6YQ0F3LH6AZVbjHoBLUpvTeNuvVI06JRqm1oUssNwjeL5r6tV0OREIslXl6Ess/RR1Zx0+aJ+Hn6XrOCO+cqs0uHCWNKlmyFl9VTjMB2WwIWsNH6YCPHtBFSfUsbyj1tDnwLXlraSLCY4kA6y/atW693Lrg18CvnaTw2sEbCKVE3K/tFd2S4CXQ1hSymQSkYGiBjrylfOCH5o//lfZptEmwjCht7e30cqcOvbUmYUEcQ29BJEWvEj0OXebFPmfxxRllBdWQppRvRiaOQJgUIKiRsQhia9NzEhXecgXp5HKqJf5CYaxatRD6WAixUj5DcIfSsxpFgJgI3DqkuQdiK4e4frWJSPNMKyFwGgrcRoMoLAdqopgx1zr2ehVhw1VxOcTZYVauJClU0chBnKnK7+TVbRk7/VknegV1+rFAFtP1GgChB2Fjs+zTjibWO5qkkU+QNj6NlPsu4V71xOnx3XbcTq9RUKY4/ymqL9W81GHKZ7smI+q47/qDrihlX1dmfqGYnMn77YcAIuWvNQ4KWo="

# workaround for travis-ci/gimme#25 to pick up latest version of gimme and run again
before_install:
  - export GIMME_OS=${TMP_GIMME_OS}
  - export GIMME_ARCH=${TMP_GIMME_ARCH}
  - export GIMME_TYPE=${TMP_GIMME_TYPE}
  - echo -e "machine github.com\n  login $GITHUB_TOKEN" >> ~/.netrc
  # - curl -o gimme -sL https://raw.githubusercontent.com/travis-ci/gimme/v0.2.4/gimme
  # - chmod u+x gimme
  # - unset GOROOT GOTOOLDIR GIMME_NO_ENV_ALIAS
  # - ./gimme -l
  # - ./gimme 1.6
  # - ./gimme -l
  # - ./gimme --force 1.6
  # - ./gimme -l
  # - source ~/.gimme/envs/go1.6.env
  - go version
  - go env

script:
  - go install -v ./...
  - chmod ugo+x travis_run_go_test.sh
  - ./travis_run_go_test.sh

after_success:
  - cd $GOPATH/bin/
  - export CURRENT_ENV_DIR=${GIMME_OS}_${GIMME_ARCH}
  - export PCKG_FILE=${CURRENT_ENV_DIR}.zip
  - mkdir -p $CURRENT_ENV_DIR/sanity_check
  - cp -f $GOPATH/bin/* $CURRENT_ENV_DIR/
  - mv $CURRENT_ENV_DIR/dbcheck $CURRENT_ENV_DIR/sanity_check/
  # Make sure that out sanity checks are also bundled with the executable
  - cp -R $TRAVIS_BUILD_DIR/dbcheck/tests $CURRENT_ENV_DIR/sanity_check/
  - zip -r $PCKG_FILE $CURRENT_ENV_DIR

before_deploy:
  # It can cause the deploy to fail, if you are not in the build dir at deploy time.
  - cd $TRAVIS_BUILD_DIR

deploy:
  provider: releases
  api_key:
    secure: G2St0z28SuPK1+7uqyHOXuwrfh6TKK+6z6rN+1pY5NJOUAF9X5mOS/MQXgT7n1kTjwNCr7buIo63CsS9Avq7Nya6xoVELixHleuI4vNXDijNKBYQcA+VJC3NUCF62XvBQDTg/GLd7HpK1hwS007MWbJ7muZ4DlRwdBi/pdHrlPYr6SDfJlh5lnJIb72tlOsfBwlAWHfY7BK3vrbFm9PiYb6NJjRDcRQr+m8dJr/Pe9ZG/4nYZoRx0vvmZjtjGAPKx2GdlLF3Xe7yUb75/3WBuznzyy1cnynQINHS6n8juRwWNwmff/uN7yvj5raQeQmi/noLGboNudGSc4/I4Kis9yXsv2eJqtqWWuQtv3qRcG4zwdAw0E5AZSWp0RtZYSWTWm1AV7t8u+sPocficJhoKLxu2rdlH1dkkNrIwbnuo0ubxDRohdnU+ru3AU5J7dH2R68ci/VK6Rr+cFkbviNwqBnIheorG4sMZZSw7LAhP7jCFzNv7PA87WUt/7LBhEPUoRZxhDUxemaAcBQYxlbLTs4uz344dK8fNu1Ky58eS/Z3eo9XCPMCHkIVosLhcS8xLTK3VvirIdv6rz8UoiPi+kx/a8oevYWqc9MByxWBKoNjQVQ3/Vw/QbuMN7AQ2cUYN+vcF3RJP8CqXoopeIoQ0HjTZcn3KX+no1WUHMFNUkI=
  file:
  - ${GOPATH}/bin/${GIMME_OS}_${GIMME_ARCH}.zip
  skip_cleanup: true
  on:
    tags: true
notifications:
  email: false
