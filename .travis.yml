language: go

go:
  - 1.6
env:
  matrix:
    - TMP_GOOS=linux TMP_GOARCH=386
    - TMP_GOOS=linux TMP_GOARCH=amd64
    - TMP_GOOS=windows TMP_GOARCH=amd64
    - TMP_GOOS=windows TMP_GOARCH=386
    - TMP_GOOS=darwin TMP_GOARCH=amd64
    - TMP_GOOS=darwin TMP_GOARCH=386
  global:
    - secure: "UJs31O6dE68f0rjWzcS0QE2tsZqrJ0lNoNO8hDe1MpblcQD5d/+ASYA8FrmeLcrUCKGK8Rh3v+fBtYokZMR4EOjf41InFTjg74Gx7eG47UxfiF2tWrwTsNFo21WeDmHgtjKmb+w/A4ODDhOZex/Dx2JgOGbRsdk611pwW47pOXuKfqWh/NgxInA/aTwy6o/wMcmEUMFU1k4FaGf4s+Wp8FbVCuoTJYe//ejYM9mj8n+4c9Ra8Pe2+dXAmD60qdMoqCIvMm4NfRgtzN+FLDhB2/kFOI0IQh5D5vX4q+Yd4x7MACdBbqgz4CwMLbkmJ65USKz0b0oKQIhSeEyNCLdW2qpXxRGRAajB6hoqs7O/Me863MEOg9Z9EB4X5RwccS3AkJMuJf4Kjc246wsilBJTQ4vgEzyzLeBQo8XRImnNfz9OgtlEpw38haRlh/2HSm5jloiB9V5aZNgECCwnwhEMbAMl1dgBOMIFQAeGds2cSHUNL9/+tG0RaXgicAfC23Cp5klq02RFA2ItpCQatRR5nu5qFFfo5NofRi85PbaKYVvpnZ/vg+EezCj8UX3Ghl2XpbGDUxh5HT7A2M/WY7JzTRhnJDMqYU25O2DuCxN4+PkPxCq13Tyr4ssPn1sP67KzRvKEDP2TLb6o2pvOY5U416IPjyRMSYQvsrBHWpofJ7s="
    - PACKAGE_VERSION=2.0.$TRAVIS_BUILD_NUMBER
    - OWNER=palette-software
    - PACKAGE=insight-tester

before_install:
  - export GOOS=${TMP_GOOS}
  - export GOARCH=${TMP_GOARCH}
  - echo -e "machine github.com\n  login $GITHUB_TOKEN" >> ~/.netrc

script:
  - go install -v ./...
  - chmod ugo+x travis_run_go_test.sh
  - ./travis_run_go_test.sh

after_success:
  - cd $GOPATH/bin/
  - export CURRENT_ENV_DIR=${GOOS}_${GOARCH}
  - export PCKG_FILE=${CURRENT_ENV_DIR}.zip
  - mkdir -p $CURRENT_ENV_DIR/sanity_check
  - cp -f $GOPATH/bin/* $CURRENT_ENV_DIR/
  - mv $CURRENT_ENV_DIR/dbcheck $CURRENT_ENV_DIR/sanity_check/
  # Make sure that out sanity checks are also bundled with the executable
  - cp -R $TRAVIS_BUILD_DIR/dbcheck/tests $CURRENT_ENV_DIR/sanity_check/
  - zip -r $PCKG_FILE $CURRENT_ENV_DIR

before_deploy:
  # It can cause the deploy to fail, if you are not in the build dir at deploy time.
  - cd $TRAVIS_BUILD_DIR

deploy:
  skip_cleanup: true
  provider: script
  # Only deploy from the master branch (and if we don't have a tag specified, because they are auto-committed)
  script: $TRAVIS_BUILD_DIR/release-to-github.sh
  on:
    # It should be master!!!
    branch: sanity_check_ok_logs
    tags: false

notifications:
  email: false
